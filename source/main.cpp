#include <nds.h>
#include <stdio.h>

// states
#include "View.h"
#include "IntroView.h"
#include "MainMenuView.h"

volatile int frame = 0;
View* currentView = nullptr;

void SwitchView(View* newView) {
    // cleanup any existing view
    if (currentView != nullptr) {
        currentView->Cleanup();

        // free memory
        delete currentView;
    }

    // load new view
    currentView = newView;
    if (currentView != nullptr) {
        currentView->Init();
    }
}

// fn for the interrupt
void Vblank() {
	frame++;
}
	
int main(void) {
	irqSet(IRQ_VBLANK, Vblank);

	// debug init
	// NOTE: for some reason, we cant use vram bank C. It might be because of consoleDemoInit...
	consoleDemoInit();

    // start with IntroView
    // SwitchView(new IntroView());

    // DEBUG
    SwitchView(new MainMenuView());

	while(pmMainLoop()) {
		swiWaitForVBlank();

        // check state of currentView
        if (currentView != nullptr) {
            ViewState nextState = currentView->Update();
            if (nextState == ViewState::INTRO) {
                SwitchView(new IntroView());
            } else if (nextState == ViewState::MAIN_MENU) {
                SwitchView(new MainMenuView());
            }
        }

		bgUpdate();
		oamUpdate(&oamMain);
	}

	return 0;
}
